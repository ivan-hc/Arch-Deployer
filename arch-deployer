#!/usr/bin/env bash

AD_VERSION="1.6.1"

ARCH=$(uname -m)
MIRROR="https://archlinux.org/packages"
CHAOTICAUR="https://builds.garudalinux.org/repos/chaotic-aur/" # UNCOMMENT TO ENABLE THE SUPPORT FOR AUR PACKAGES (CHAOTIC AUR)

_DIVIDING_LINE() {
	printf "\n############################################################################\n\n"
}

_fit() {
	command -v tput >/dev/null 2>&1 && fold -sw "$(("$(tput cols)"-"3"))" | sed 's/^/ /g' || fold -sw 77 | sed 's/^/ /g'
}

_online_check() {
	if ! wget -q --tries=10 --timeout=20 --spider https://archlinux.org/; then
		if command -v torsocks >/dev/null 2>&1; then
			if ! torsocks wget -q --tries=10 --timeout=20 --spider https://archlinux.org/; then
				printf "\n https://archlinux.org is offline, please check your internet connection and try again\n\n" | _fit
				exit 0
			else
				use_torsocks="torsocks"
			fi
		else
			printf "\n https://archlinux.org is offline, please check your internet connection and try again\n\n" | _fit
			exit 0
		fi
	fi
}

HELP_MESSAGE_HEADER="

        ╭━━━┳━━━┳━━━┳╮╱╭╮╭━━━┳━━━┳━━━┳╮╱╱╭━━━┳╮╱╱╭┳━━━┳━━━╮
        ┃╭━╮┃╭━╮┃╭━╮┃┃╱┃┃╰╮╭╮┃╭━━┫╭━╮┃┃╱╱┃╭━╮┃╰╮╭╯┃╭━━┫╭━╮┃
        ┃┃╱┃┃╰━╯┃┃╱╰┫╰━╯┃╱┃┃┃┃╰━━┫╰━╯┃┃╱╱┃┃╱┃┣╮╰╯╭┫╰━━┫╰━╯┃
        ┃╰━╯┃╭╮╭┫┃╱╭┫╭━╮┃╱┃┃┃┃╭━━┫╭━━┫┃╱╭┫┃╱┃┃╰╮╭╯┃╭━━┫╭╮╭╯
        ┃╭━╮┃┃┃╰┫╰━╯┃┃╱┃┃╭╯╰╯┃╰━━┫┃╱╱┃╰━╯┃╰━╯┃╱┃┃╱┃╰━━┫┃┃╰╮
        ╰╯╱╰┻╯╰━┻━━━┻╯╱╰╯╰━━━┻━━━┻╯╱╱╰━━━┻━━━╯╱╰╯╱╰━━━┻╯╰━╯"
HELP_MESSAGE="$(_DIVIDING_LINE)

A script to bulk download an arch linux package with all its dependencies to be converted in appimage. add the name of a program from the arch linux repositories and chaotic-aur.
 
USAGE:
	arch-deployer \$PROGRAM (download a program)

	arch-deployer -v (show the version)

	arch-deployer -h (show this message)

All packages are taken from https://archlinux.org/packages, AUR packages are taken from \"chaotic-aur\" instead, at https://builds.garudalinux.org/repos/chaotic-aur
$(_DIVIDING_LINE)

SITE:

	https://github.com/ivan-hc/arch-deployer

SEE ALSO:

	https://github.com/ivan-hc/ArchImage

	https://github.com/ivan-hc/AM 
"

_appimagetool() {
	if ! command -v appimagetool 1>/dev/null; then
		[ ! -f ./appimagetool ] && echo " Downloading appimagetool..." && curl -#Lo appimagetool https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-"$ARCH".AppImage && chmod a+x ./appimagetool
		./appimagetool "$@"
	else
		appimagetool "$@"
	fi
}

_create_apprun() {
	rm -f AppRun
	cat <<-'HEREDOC' >> AppRun
	#!/bin/sh

	HERE="$(dirname "$(readlink -f "${0}")")"

	export PATH="${HERE}"/usr/bin/:"${HERE}"/usr/sbin/:"${HERE}"/usr/games/:"${HERE}"/bin/:"${HERE}"/sbin/:"${PATH}"

	lib_dirs=$(find "$HERE"/usr/lib -type d | sed 's#usr/lib/#DEL\n#g' | grep -v DEL$)
	for d in $lib_dirs; do
		export LD_LIBRARY_PATH="${HERE}"/usr/lib/"$d"/:"${LD_LIBRARY_PATH}"
	done

	export LD_LIBRARY_PATH="${HERE}"/usr/lib/:"${HERE}"/usr/lib64/:"${HERE}"/usr/lib32/:"${HERE}"/lib64/:"${HERE}"/lib32/:"${HERE}"/lib/:"${LD_LIBRARY_PATH}"

	export XDG_DATA_DIRS="${HERE}"/usr/share/:"${XDG_DATA_DIRS}"

	if test -d "${HERE}"/usr/lib/python*; then
		PYTHONVERSION=$(find "${HERE}"/usr/lib -type d -name "python*" | head -1 | sed 's:.*/::')
		export PYTHONPATH="${HERE}"/usr/lib/"$PYTHONVERSION"/site-packages/:"${HERE}"/usr/lib/"$PYTHONVERSION"/lib-dynload/:"${PYTHONPATH}"
		export PYTHONHOME="${HERE}"/usr/
	fi

	export PERLLIB="${HERE}"/usr/share/perl5/:"${HERE}"/usr/lib/perl5/:"${PERLLIB}"

	export GSETTINGS_SCHEMA_DIR="${HERE}"/usr/share/glib-2.0/schemas/:"${GSETTINGS_SCHEMA_DIR}"

	QTVER=$(find "${HERE}"/usr/lib -type d -name "qt*" | head -1 | sed 's:.*/::')
	if [ -z "$QTVER" ]; then
		export QT_PLUGIN_PATH="${HERE}"/usr/lib/"$QTVER"/plugins/:"${HERE}"/usr/lib/x86_64-linux-gnu/"$QTVER"/plugins/:"${HERE}"/usr/lib64/"$QTVER"/plugins/:"${HERE}"/lib/"$QTVER"/plugins/:"${HERE}"/lib64/"$QTVER"/plugins/:"${QT_PLUGIN_PATH}"
	fi

	APP=SAMPLE
	if [ -f "${HERE}"/usr/lib/"$APP"/"$APP" ]; then
		exec "${HERE}"/usr/lib/"$APP"/"$APP" "$@"
	elif [ -f "${HERE}"/usr/bin/"$APP" ]; then
		exec "${HERE}"/usr/bin/"$APP" "$@"
	else
		echo "No binary found in \$PATH"
	fi
	HEREDOC
	chmod a+x AppRun
	sed -i "s/SAMPLE/$BIN/g" AppRun
}

case "$1" in
	-h|--help )
		echo "$HELP_MESSAGE_HEADER"
		echo "$HELP_MESSAGE" | _fit
		;;
	-v|--version )
		echo "$AD_VERSION"
		;;
	'' )
		printf "\nPlease add the name of a program from the arch linux repositories\n\nUSAGE:     arch-deployer \$PROGRAM\n\n" | _fit
		;;
	* )
		APP="$1"

		_online_check

		# Name the executable in /usr/bin if different from the appname
		read -r -ep "◆ NAME THE MAIN EXECUTABLE IN \$PATH, OR LEAVE BLANK IF IT IS THE SAME: " BIN
    		[ -z "$BIN" ] && BIN="$APP"

		if [ -d ./"$APP"/"$APP".AppDir ]; then
			_DIVIDING_LINE
			echo " The $APP.AppDir directory already exists!"
			sleep 2
		else
			# DOWNLOADING THE APPLICATION
			mkdir -p ./"$APP" && cd ./"$APP" || exit 1
			for REPO in core extra community multilib; do
				$use_torsocks wget -q --no-verbose --show-progress --progress=bar "${MIRROR}/${REPO}/${ARCH}/$APP/download" --trust-server-names
			done
			if ! test -f "$APP"-*.tar.zst; then
				wget -r -A "$APP"-*.tar.zst -nd "${CHAOTICAUR}"/"${ARCH}"/
			fi
			tar xf ./*.tar.zst

			# READ AND/OR EDIT THE DEPENDENCES LIST
			DEP=$( cat ./.PKGINFO | grep "^depend = " | sed 's/depend = //g' | sed 's/=.*//' )
			echo "$DEP" | tr ' ' '\n' | sort >> DEP
			echo ""
			cat DEP
			_DIVIDING_LINE
			while true; do
				read -r -p " DO YOU WISH TO ADD OTHER PACKAGES TO THE LIST (y/N)?" response
				if echo "$response" | grep -qi "^y"; then
					echo ""
					echo ' OPENING THE "DEP" FILE USING YOUR DEFAULT TEXT EDITOR'
					xdg-open DEP
					echo ""
					while true; do
						read -r -p  " PRESS ENTER TO CONTINUE" response
						case $response in
						* )
							echo ""
							echo " THE FOLLOWING PACKAGES WILL BE DOWNLOADED:"
							echo ""
							cat DEP
							echo ""
							break
						esac
					done
				else
					echo ""
					echo " OK, LET'S GO!"
					echo ""
					break
				fi
			done

			# DOWNLOAD AND EXTRACT THE DEPENDENCE'S PACKAGES TO THE APPDIR
			ARGS=$( cat ./DEP )
			for pkg in ${ARGS} ; do
				for REPO in core extra community multilib; do
					$use_torsocks wget -q --no-verbose --show-progress --progress=bar "${MIRROR}/${REPO}/${ARCH}/$pkg/download" --trust-server-names
				done
				if ! test -f "$pkg"-*.tar.zst; then
					wget -r -A "$pkg"-*.tar.zst -nd "${CHAOTICAUR}"/"${ARCH}"/
				fi
			done
			
			for f in *.tar.zst; do 
				tar xf "$f" 2>/dev/null
			done
			mkdir -p ./"$APP".AppDir
			dirs="bin boot dev etc lib lib64 libx32 lib32 media mnt opt proc run sbin srv sys tmp usr var"
			for d in $dirs; do
				mv ./"$d" ./"$APP".AppDir/ 2>/dev/null
			done

			# DOWNLOADING APPIMAGETOOL (TO EXPORT THE APPDIR TO AN APPIMAGE)
			_appimagetool

			# CREATING THE APPRUN SCRIPT
			_create_apprun
			mv ./AppRun ./"$APP".AppDir/

			# TRY TO COPY ICON AND LAUNCHER INTO THE APPDIR
			LAUNCHER=$(grep -iRl "$BIN" ./"$APP".AppDir/usr/share/applications/* | grep ".desktop" | head -1)
			cp -r "$LAUNCHER" "$APP".AppDir/
			ICON=$(cat "$LAUNCHER" | grep "Icon=" | cut -c 6-)
			[ -z "$ICON" ] && ICON="$BIN"
			cp -r ./"$APP".AppDir/usr/share/icons/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/22x22/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/24x24/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/32x32/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/48x48/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/64x64/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/128x128/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/192x192/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/256x256/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/512x512/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/icons/hicolor/scalable/apps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cp -r ./"$APP".AppDir/usr/share/pixmaps/*"$ICON"* "$APP".AppDir/ 2>/dev/null
			cd ..
			_DIVIDING_LINE
			echo " The $APP.AppDir is ready!"
			echo ' You may check it for issues to fix before you export it to an AppImage.'
			sleep 2
			_DIVIDING_LINE
		fi
	echo "" 
	sleep 1

	# CHECK THE APPDIR (QUESTION)
	while true; do
		read -r -p  " DO YOU WISH TO CHECK THE $APP.AppDir FIRST (Y/n)?" response
		if ! echo "$response" | grep -qi "^n"; then
			_DIVIDING_LINE
			echo " Opening the $APP.AppDir directory!"
			sleep 1
			echo ""
			echo " Exec the AppRun (command './AppRun') to test if everything works!"
			sleep 1
			xdg-open ./"$APP"/"$APP".AppDir
			echo ""
			break
		else
			break
		fi
	done

	# DOWNLOAD OTHER PACKAGES (IF NEEDED)
	while true; do
		read -r -p  " DO YOU WISH TO ADD OTHER PACKAGES (Y,n)?" response
		if ! echo "$response" | grep -qi "^n"; then
			while true; do
				read -r -p " PLEASE, ENTER THE PACKAGE NAME (or leave empty to continue): " packagename
				if [ -n "$packagename" ]; then
					for pkg in $packagename; do
						chmod -R 777 ./"$APP"/"$APP".AppDir
						cd ./"$APP"/"$APP".AppDir || exit 1
						for REPO in core extra community multilib; do
							$use_torsocks wget -q --no-verbose --show-progress --progress=bar "${MIRROR}/${REPO}/${ARCH}/$pkg/download" --trust-server-names
						done
						if ! test -f "$pkg"-*.tar.zst; then
							wget -r -A "$pkg"-*.tar.zst -nd "${CHAOTICAUR}"/"${ARCH}"/
						fi
						tar xf "$packagename".tar.zst
						chmod -R 777 ./*
						rm -f ./2 ./.* ./*.tar.zst
						echo ""
					done
				else
					break
				fi
			done
		fi

		# EXPORT THE APPDIR TO AN APPIMAGE
		while true; do
			read -r -p  " Do you wish to export $APP.AppDir to an AppImage (Y/n)?" response
			if ! echo "$response" | grep -qi "^n"; then
				echo ""
				ARCH=$(uname -m) _appimagetool -n ./"$APP"/"$APP".AppDir 2>/dev/null
				mv ./*.AppImage "$(xdg-user-dir DESKTOP)" 2>/dev/null
				_DIVIDING_LINE
				echo " $APP has been exported on your desktop!"
				echo ""
				echo " Repeat this operation in case the AppImage doesn't work:"
				echo ""
			else
				break
			fi
		done
		_DIVIDING_LINE
		echo '  THANK YOU FOR USING ARCH-DEPLOYER!'
		echo ""
		echo "  Please consider submitting your application to \"AM\""
		echo ""
		echo "  SITE: https://github.com/ivan-hc/AM"
		echo ""
		echo "############################################################################"
		exit 
	done
esac
